name: Flutter CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  # Run tests and analysis
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Run code generation
      run: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  # Build development APK
  build-dev:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Install dependencies
      run: flutter pub get

    - name: Run code generation
      run: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Build development APK
      run: |
        flutter build apk \
          -t lib/main_dev.dart \
          --flavor dev \
          --debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-dev-debug.apk
        path: build/app/outputs/flutter-apk/app-dev-debug.apk

  # Build production APK and App Bundle
  build-prod:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Install dependencies
      run: flutter pub get

    - name: Run code generation
      run: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Build production APK
      run: |
        flutter build apk \
          -t lib/main_prod.dart \
          --flavor prod \
          --release \
          --obfuscate \
          --split-debug-info=build/symbols

    - name: Build production App Bundle
      run: |
        flutter build appbundle \
          -t lib/main_prod.dart \
          --flavor prod \
          --release \
          --obfuscate \
          --split-debug-info=build/symbols

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-prod-release.apk
        path: build/app/outputs/flutter-apk/app-prod-release.apk

    - name: Upload App Bundle artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-prod-release.aab
        path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

    - name: Upload debug symbols
      uses: actions/upload-artifact@v4
      with:
        name: debug-symbols
        path: build/symbols/

  # Build iOS (optional - requires macOS runner)
  # build-ios:
  #   runs-on: macos-latest
  #   needs: test
  #   if: github.ref == 'refs/heads/main'
  #
  #   steps:
  #   - uses: actions/checkout@v4
  #
  #   - name: Setup Flutter
  #     uses: subosito/flutter-action@v2
  #     with:
  #       flutter-version: '3.19.0'
  #       channel: 'stable'
  #
  #   - name: Install dependencies
  #     run: flutter pub get
  #
  #   - name: Run code generation
  #     run: flutter pub run build_runner build --delete-conflicting-outputs
  #
  #   - name: Install pods
  #     run: |
  #       cd ios
  #       pod install
  #       cd ..
  #
  #   - name: Build iOS
  #     run: |
  #       flutter build ios \
  #         -t lib/main_prod.dart \
  #         --release \
  #         --obfuscate \
  #         --split-debug-info=build/symbols \
  #         --no-codesign

